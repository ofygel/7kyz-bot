# Интеграция SPA и Telegram-бота курьерских заказов

## 1. Архитектура обмена
- Telegram-бот развернут поверх Telegraf и принимает входящие апдейты через вебхук, который отдаёт Express-приложение (подключены Sentry, helmet, CORS, rate limit, JSON body parser). 【F:src/index.ts†L132-L172】
- После получения webhook-запроса `app.handleUpdate` обрабатывает апдейт внутри Telegraf, что значит: любая серверная логика оформления заказов должна быть доступна из Node.js-процесса бота. 【F:src/index.ts†L161-L164】
- SPA должна вызывать серверные методы того же backend-репозитория (или его обёртки), чтобы создавать/изменять заказы в том же Postgres и триггерить Telegram-логику.

## 2. Контракт заказа и валидаторы
- Вся серверная логика опирается на тип `OrderInsertInput`/`OrderRecord`: вид услуги (`delivery`/`taxi`), город, контактные данные, адреса с координатами и ссылками 2ГИС, параметры подъезда, рассчитанная цена, исполнитель и пр. 【F:src/types/orders.ts†L3-L84】
- Черновик заказа считается валидным, только если заполнены обе точки, рассчитана цена, известен тип адреса, телефон получателя, а для многоквартирного дома — квартира/подъезд/этаж. 【F:src/bot/services/orders.ts†L49-L61】
- Для доставки бот принудительно просит ссылки 2ГИС, проверяет принадлежность точек выбранному городу и отсеивает слишком далёкие маршруты (≥120 км) — SPA должна повторить эти проверки до отправки на backend. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L117-L185】
- Телефоны нормализуются до E.164 (`normaliseRecipientPhone`), поэтому клиентский SPA должен либо использовать тот же helper, либо повторять форматирование. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L96-L99】

## 3. Пайплайн создания заказа из SPA
1. **Сбор данных.** SPA формирует DTO в формате `OrderInsertInput` и гарантирует, что пользователь выбрал город и подтвердил комментарий/тип адреса/контакты (правила выше).
2. **Сохранение в БД.** Бэкенд вызывает `createOrder`, который вставляет запись со статусом `new` и возвращает полный `OrderRecord`. 【F:src/db/orders.ts†L223-L329】
3. **Публикация в канал.** Сразу после сохранения вызывается `publishOrderToDriversChannel`:
   - функция атомарно открывает заказ (статус `open`), если он ещё `new`, и отправляет карточку в канал исполнителей; сообщение включает основные поля и комментарий. 【F:src/db/orders.ts†L367-L399】【F:src/bot/channels/ordersChannel.ts†L642-L707】【F:src/bot/channels/ordersChannel.ts†L142-L149】
   - к сообщению прикручена inline-клавиатура с кнопками «Беру заказ»/«Недоступен» и кнопками адресов. 【F:src/bot/channels/ordersChannel.ts†L618-L645】
   - при повторной публикации (например, после отмены исполнителем) возвращается `already_published`, поэтому SPA должна обрабатывать этот статус, не создавая дублей. 【F:src/bot/channels/ordersChannel.ts†L671-L706】
4. **Fallback на ошибки.** Если публикация не удалась (исключение), код помечает заказ как отменён (`markOrderAsCancelled`), а пользователю показывается, что оператор обработает вручную; этот же подход нужно применить в SPA. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L954-L989】
5. **Пользовательский статус.** После успешного/частично успешного создания `notifyOrderCreated` строит статусный экран, карточку заказа и отправляет отчёт в статистику — SPA должна отображать такие же статусы и вызывать `reportOrderCreated`. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L829-L882】

## 4. Жизненный цикл заказа после публикации
### 4.1. Решения исполнителей в канале
- Все нажатия inline-кнопок проходят через `processOrderAction`, где заказ блокируется `FOR UPDATE`, проверяется город исполнителя, лимиты по активным заказам и роль (водитель/курьер). 【F:src/bot/channels/ordersChannel.ts†L716-L765】【F:src/db/orders.ts†L386-L498】
- При успехе статус меняется на `claimed`, сообщение из канала обновляется/удаляется, исполнителю прилетает личное сообщение с подробностями и кнопками «Завершить»/«Отменить», а клиент получает уведомление о назначении. 【F:src/bot/channels/ordersChannel.ts†L1059-L1099】【F:src/bot/channels/ordersChannel.ts†L157-L168】【F:src/bot/channels/ordersChannel.ts†L198-L236】
- При отказе исполнителя inline-клавиатура чистится, чтобы избежать повторных нажатий, и заказ остаётся `open`. 【F:src/bot/channels/ordersChannel.ts†L1102-L1108】【F:src/bot/channels/ordersChannel.ts†L402-L470】
- В статистику улетают события публикации/назначения/отказа (`reportOrderPublished`, `reportOrderClaimed`, `reportOrderReleased`), поэтому SPA не должна дублировать эти отчёты, а реиспользовать сервис. 【F:src/bot/channels/ordersChannel.ts†L701-L706】【F:src/bot/channels/ordersChannel.ts†L1099-L1100】【F:src/bot/channels/ordersChannel.ts†L1177-L1202】

### 4.2. Работа исполнителя после назначения
- Исполнитель управляет заказом через личный чат: бот показывает активные заказы и позволяет получить контакты или завершить доставку. 【F:src/bot/flows/executor/orders.ts†L277-L344】
- Завершение инициирует `completeOrderByExecutor`, который переводит статус в `finished`, уведомляет клиента и обновляет список активных заказов. 【F:src/db/orders.ts†L620-L655】【F:src/bot/flows/executor/orders.ts†L297-L341】
- Если требуется вернуть заказ в канал (например, исполнитель отказался), используется `handleOrderRelease`: заказ открывается повторно, в чат исполнителя отправляется карточка с кнопкой «Вернуть заказ», и снова вызывается публикация. 【F:src/bot/channels/ordersChannel.ts†L1116-L1202】

### 4.3. Отмена клиентом
- Клиентское действие в SPA должно вызывать `cancelClientOrder`, которое меняет статус на `cancelled` только для заказов `open/claimed` и подтягивает данные исполнителя. 【F:src/db/orders.ts†L818-L846】
- После этого нужно вызвать `handleClientOrderCancellation`, чтобы удалить сообщение из канала, очистить кеш состояний и уведомить исполнителя личным сообщением. 【F:src/bot/channels/ordersChannel.ts†L409-L455】

### 4.4. Дополнительные статусы
- Статусы `in_progress` и `expired` поддерживаются на уровне БД/форматеров (например, авто-истечение через `expireStaleOrders`), поэтому SPA должна корректно отображать их в интерфейсе. 【F:src/types/orders.ts†L5-L12】【F:src/db/orders.ts†L688-L746】【F:src/bot/orders/formatting.ts†L14-L70】

## 5. Получение и отображение данных в SPA
- Для клиентского кабинета используйте `listClientOrders` (поддерживает фильтрацию по статусам и лимиты) и `getOrderWithExecutorById` для детального просмотра. 【F:src/db/orders.ts†L752-L806】【F:src/db/orders.ts†L808-L846】
- Для личного кабинета исполнителя есть `listExecutorOrders` (выдаёт активные `claimed/in_progress`). 【F:src/db/orders.ts†L620-L636】
- Формат карточки/контактной информации можно воспроизвести, опираясь на `buildOrderDetailText`, `buildOrderContactKeyboard` и `formatExecutorLabel`, чтобы UI SPA совпадал с Telegram. 【F:src/bot/orders/formatting.ts†L1-L148】

## 6. Обработка ошибок и наблюдаемость
- Любые ошибки публикации/перевода статусов логируются и завершаются отчётами, поэтому SPA важно повторять шаблон try/catch: при fail публиковать уведомление клиенту, откатывать статус и сигнализировать в поддержку. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L954-L986】【F:src/bot/channels/ordersChannel.ts†L710-L713】
- Активные заказы учитываются в бизнес-метриках (`activeOrdersGauge`), поэтому не пропускайте вызовы репозиториев БД — прямое обновление таблицы минуя функции нарушит счётчики. 【F:src/db/orders.ts†L180-L220】【F:src/db/orders.ts†L410-L497】

## 7. Что должно уметь SPA
1. **Создавать заказы** через тот же backend, вызывая `createOrder` + `publishOrderToDriversChannel` и обрабатывая статусы ответа.
2. **Показывать статусы** (`new/open/claimed/in_progress/finished/cancelled/expired`) и детали заказа в соответствии с форматами бота.
3. **Давать клиенту управление** — отмена (`cancelClientOrder` → `handleClientOrderCancellation`), повтор заказа, просмотр контактов исполнителя.
4. **Синхронизироваться с Telegram** — показывать уведомления о назначении/завершении на основании `notifyClientAboutOrderUpdate` и пушей в Telegram.
5. **Логировать и мониторить** — пробрасывать ошибки публикации в поддержку, чтобы закрывать заказы вручную, если канал недоступен.

Следуя этим шагам, SPA и бот будут работать с единой базой данных и одинаковой логикой статусов, а значит, исполнители смогут брать заказы из канала, общаться в Telegram и параллельно вести процесс из SPA без расхождений.
