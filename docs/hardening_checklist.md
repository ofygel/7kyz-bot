# Чек-лист доработок перед «боевым» релизом

Этот список фиксирует технические долги, которые стоит закрыть, чтобы бот выдерживал нагрузку и неожиданные сбои «как у больших» сервисов. Пункты сгруппированы по направлениям: база данных, доступы, согласованность бизнес-логики, эксплуатация и UX.

| Блок | Что улучшить | Зачем |
| --- | --- | --- |
| База данных | 1) Миграция `order_status` → добавить `in_progress`. 2) Выполнить `CREATE INDEX CONCURRENTLY ON orders (claimed_by) WHERE status IN ('claimed','in_progress')`. | Без нового статуса API упадёт на попытке обновления; частичный индекс убирает full-scan при выборке активных заказов исполнителя. |
| RLS / ACL | Если включена RLS — расширить политики для `in_progress`. | Без обновления политик исполнитель получит 0 строк и бот «ослепнет». |
| Согласованность статусов | Ввести явную конечную автомату состояний (например, `typescript-fsm`), запретив переходы вне списка. | Статусы управляются кодом, а не догадками в SQL, что исключает «зависания». |
| Idempotency & race-free | Переписать `tryClaim`/`tryComplete` на `SELECT … FOR UPDATE SKIP LOCKED` внутри одной транзакции. | При одновременных кликах побеждает один, второй получает `null`, UI честно сообщает «заказ уже взят». |
| Наблюдаемость | Добавить счётчики: `orders_claim_total`, `orders_finish_total`, `orders_finish_error_total{reason}` и использовать `executor_active_orders` как gauge. | Появляется прозрачность: видно, где тормозит клиент, исполнитель или бот. |
| Alerting | Правило `rate(orders_finish_error_total[5m]) > 0.03` → Telegram/Sentry. | Узнаёте о деградации раньше клиента. |
| Автотесты | e2e через `telegraf-testing` или `grammy/testing`: 1) happy-path создания/взятия/завершения заказа. 2) Клиент отменяет заказ в статусах open/claimed/in_progress. 3) Параллельный `claim` двумя исполнителями. | Регрессы ловятся одной командой `npm test`. |
| CI | Запуск lint + type-check + unit + e2e в GitHub Actions. Для миграций — `prisma migrate diff` или `sqlx migrate verify`. | Без зелёной сборки PR не попадает в `main`, схема не «уплывает». |
| UX-мелочи | 1) Клиенту показывать ETA не только при создании, но и в «Моих заказах». 2) Добавить исполнителю кнопку «Отменить взятие» до фактического старта. | Сглаживаем пользовательский опыт и снижаем простой очереди. |
| Защита от спама | Ввести `telegraf-ratelimit` на приватный чат: ≤1 callback-action/секунду. | Telegram не вернёт `FLOOD_WAIT`. |
| Fail-safe UI | Обернуть `ui.step()` в retry-helper (3 попытки × 200 мс при `429` или timeout). | Сетевые лаги не ломают пользовательский сценарий. |

## Короткий план работ

1. Выполнить миграцию enum + индекс **до** выката кода и обновить RLS-политику.
2. Ввести FSM константы и unit-тест запретного перехода.
3. Переписать `tryClaim`/`tryComplete` с блокировками `FOR UPDATE SKIP LOCKED`.
4. Подключить Prometheus-метрики и настроить alert rule на рост ошибок завершения.
5. Добавить e2e-тесты в CI и сделать их обязательными для PR.
6. Поставить rate-limiter на callback-запросы и retry-хелпер для `ui.step()`.

Выполнение этих пунктов делает бота значительно более устойчивым: логи остаются чистыми, статусы не «дрифтуют», а регрессии ловятся тестами и алертами.
