# Статус выполнения ТЗ (27.09.2025)

## Ключевые ориентиры технического задания
- Клиентский сценарий: /start → обязательный запрос телефона → выбор города → оформление заказа (такси или доставка) с нормализацией адресов и публикацией в канал, далее — отслеживание статусов заказа.
- Исполнительский сценарий: /start → выбор роли (курьер/водитель) → проверка верификации документов → активация пробного периода → доступ к заказам, управляемый подписками.
- Операционная устойчивость: safe-mode при сбоях БД, идемпотентность кнопок и команд, надёжный health-check (`ok`, `db`, `schema`, `safe_mode`).
- Администрирование: команды привязки каналов, отчёты в стат-канал, модерация и поддержка.
- Эксплуатация: миграции без ручных правок, мониторинг и метрики, покрытие ключевых сценариев тестами.

## Что уже реализовано
- **Онбординг клиентов с обязательным номером телефона** — шаг приветствия вызывает `askPhone`, блокирует продолжение без контакта и применяет клиентские команды после верификации номера. 【F:src/bot/commands/start.ts†L55-L151】【F:src/bot/flows/common/phoneCollect.ts†L24-L96】
- **Выбор и сохранение города** с защитой от смены при активном заказе и восстановлением меню. 【F:src/bot/flows/common/citySelect.ts†L17-L173】
- **Оформление заказов (доставка и такси)**: сбор адресов через ссылки 2ГИС, расчёт цены/дистанции и публикация в канал с кнопкой «Взять». 【F:src/bot/flows/client/deliveryOrderFlow.ts†L15-L207】【F:src/bot/flows/client/taxiOrderFlow.ts†L23-L210】【F:src/bot/channels/ordersChannel.ts†L35-L210】
- **Обработка статусов и обратная связь клиенту** — отчёты и уведомления обновляют состояние заказов и отправляют сообщения о результатах. 【F:src/bot/services/orders.ts†L31-L210】【F:src/bot/services/reports.ts†L41-L210】
- **Верификация исполнителей и модерация**: бот запрашивает фото, отправляет заявки в модерационный канал и обрабатывает решения очередью. 【F:src/bot/flows/executor/verification.ts†L18-L210】【F:src/bot/moderation/verifyQueue.ts†L18-L210】
- **Пробный период и подписки**: тарифы и пробный период конфигурируются через `TRIAL_DAYS` и Plan durations, активация/продление подписок ведёт запись в БД и синхронизацию доступа. 【F:src/domain/executorPlans.ts†L4-L108】【F:src/bot/flows/executor/subscription.ts†L19-L205】【F:src/db/subscriptions.ts†L249-L489】【F:src/config/env.ts†L416-L623】
- **Safe-mode и устойчивость при сбоях**: ошибки сессий переводят пользователя в безопасный режим, а стартовая инициализация повторяет проверку схемы и очередей при недоступности БД. 【F:src/bot/services/cleanup.ts†L8-L88】【F:src/bot/flows/common/safeMode.ts†L14-L87】【F:src/app.ts†L52-L211】
- **Подпись callback-кнопок и защита от «зомби»** — HMAC c TTL и хранение surrogate-токенов; идемпотентность действий через `recent_actions`. 【F:src/bot/services/callbackTokens.ts†L1-L204】【F:src/bot/middlewares/idempotency.ts†L1-L74】
- **Администрирование каналов и служебные команды**: `/bind_*` команды, синхронизация заявок на вступление и публикации отчётов. 【F:src/bot/commands/bind.ts†L20-L210】【F:src/bot/channels/joinRequests.ts†L5-L125】【F:src/bot/services/reports.ts†L706-L840】
- **Health-check, соответствующий ТЗ** — эндпоинт `/healthz` теперь сообщает `db`, `schema` и `safe_mode`, а `/readyz` использует тот же снимок здоровья и метрики. 【F:src/http/health.ts†L1-L120】【F:src/index.ts†L126-L156】

## Закрытая проблема
- **Отсутствие требуемого статуса в health-check**: прежняя реализация возвращала только `ok/version/revision/timestamp`, что не соответствовало регламенту мониторинга. Добавлены проверки БД, схемы и safe-mode, а также коды ответа 503 при деградации. 【F:src/http/health.ts†L1-L120】

## Невыполненные требования
- **Жёсткая проверка версии схемы (`schema_meta` + REQUIRED_SCHEMA_VERSION)** отсутствует: миграции выполняются автоматически, но версионность не фиксируется и несовместимость не распознаётся. 【F:src/db/bootstrap.ts†L1-L118】
- **Слой портов/адаптеров не выделен** — бизнес-логика напрямую вызывает SQL-репозитории (например, поток оформления доставки импортирует `db/orders`), что нарушает оговорённую hex-архитектуру. 【F:src/bot/flows/client/deliveryOrderFlow.ts†L5-L21】
- **Автоматические тесты ключевых сценариев отсутствуют**: в `package.json` нет test-скрипта, а каталогов `test/` и `tests/` в текущей ветке больше нет, поэтому критерии приёмки §18 не выполняются. 【F:package.json†L8-L27】

## Рекомендации по доработке
1. Добавить модуль контроля версии схемы (таблица `schema_meta`, константа `REQUIRED_SCHEMA_VERSION`, проверка в рантайме).
2. Выделить слой портов/адаптеров или хотя бы ввести интерфейсы репозиториев, чтобы отделить бизнес-логику от SQL.
3. Вернуть и автоматизировать тесты для сценариев клиента/исполнителя, а также интеграционные health-check проверки.
4. Продолжить покрывать мониторинг: расширить readiness-report, добавить алерты по safe-mode/DB деградации.
